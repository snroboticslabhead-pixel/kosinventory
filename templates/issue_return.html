{% extends "base.html" %}

{% block title %}Component Issue & Return Management{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 lg:mb-8">
        <div>
            <h1 class="text-2xl lg:text-3xl font-bold tracking-tight text-slate-900 dark:text-white">Issue & Return Components</h1>
            <p class="mt-1 text-sm lg:text-base font-normal text-slate-500 dark:text-slate-400">Manage the lifecycle of lab components from issuing to returning.</p>
        </div>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message mb-4 lg:mb-6 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-4 lg:p-6">
        <div class="max-w-md">
            <div class="flex h-10 items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 p-1">
                <label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 has-[:checked]:bg-white has-[:checked]:dark:bg-slate-600 has-[:checked]:shadow-sm has-[:checked]:text-primary text-slate-500 dark:text-slate-400 text-sm font-medium transition-all">
                    <span class="truncate">Issue</span>
                    <input checked="" class="invisible w-0" name="form-tab" type="radio" value="issue" onchange="toggleTransactionType('issue')"/>
                </label>
                <label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 has-[:checked]:bg-white has-[:checked]:dark:bg-slate-600 has-[:checked]:shadow-sm has-[:checked]:text-primary text-slate-500 dark:text-slate-400 text-sm font-medium transition-all">
                    <span class="truncate">Return</span>
                    <input class="invisible w-0" name="form-tab" type="radio" value="return" onchange="toggleTransactionType('return')"/>
                </label>
            </div>
        </div>
        <div class="mt-6">
            <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <label class="flex flex-col">
                    <p class="text-sm font-medium pb-2 text-slate-700 dark:text-slate-300">Select Lab</p>
                    <select class="form-select w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 placeholder:text-slate-400 focus:border-primary focus:ring-primary/50" id="lab" onchange="loadComponentsByLab()" required>
                        <option value="">Select Lab</option>
                        {% for lab in labs %}
                        <option value="{{ lab.name }}">{{ lab.name }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="flex flex-col">
                    <p class="text-sm font-medium pb-2 text-slate-700 dark:text-slate-300">Select Component</p>
                    <select class="form-select w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 placeholder:text-slate-400 focus:border-primary focus:ring-primary/50" id="component" required>
                        <option value="">Select Component</option>
                    </select>
                </label>
                <label class="flex flex-col">
                    <p class="text-sm font-medium pb-2 text-slate-700 dark:text-slate-300">Or Enter UID</p>
                    <input class="form-input w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 placeholder:text-slate-400 focus:border-primary focus:ring-primary/50" id="componentUid" placeholder="e.g., COML1-001" onchange="loadComponentByUid()"/>
                    <p class="text-xs text-slate-500 mt-1">Enter UID to auto-fill component details</p>
                </label>
                <label class="flex flex-col">
                    <p class="text-sm font-medium pb-2 text-slate-700 dark:text-slate-300">Recipient Name</p>
                    <input class="form-input w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 placeholder:text-slate-400 focus:border-primary focus:ring-primary/50" id="recipient" placeholder="E.g. Jane Doe" required/>
                </label>
                <label class="flex flex-col">
                    <p class="text-sm font-medium pb-2 text-slate-700 dark:text-slate-300">Campus Name</p>
                    <input class="form-input w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 placeholder:text-slate-400 focus:border-primary focus:ring-primary/50" id="campus" placeholder="E.g. Main Campus" required/>
                </label>
                <label class="flex flex-col">
                    <p class="text-sm font-medium pb-2 text-slate-700 dark:text-slate-300" id="quantityLabel">Quantity to Issue</p>
                    <input class="form-input w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 placeholder:text-slate-400 focus:border-primary focus:ring-primary/50" id="quantity" placeholder="E.g. 5" type="number" min="1" required/>
                </label>
                <div class="md:col-span-2 lg:col-span-4">
                    <label class="flex flex-col">
                        <p class="text-sm font-medium pb-2 text-slate-700 dark:text-slate-300">Purpose (Optional)</p>
                        <textarea class="form-textarea w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 placeholder:text-slate-400 focus:border-primary focus:ring-primary/50" id="purpose" placeholder="Describe the purpose for issuing this component..." rows="2"></textarea>
                    </label>
                </div>
            </form>
            <div class="flex justify-end mt-4">
                <button onclick="createTransaction()" class="flex items-center justify-center gap-2 px-6 py-2.5 bg-primary text-white text-sm font-medium rounded-lg shadow-sm hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary w-full md:w-auto" id="submitButton">Issue Component</button>
            </div>
        </div>
    </div>

    <div class="mt-6 lg:mt-8">
        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl">
            <div class="p-4 lg:p-6">
                <h2 class="text-lg lg:text-xl font-bold text-slate-900 dark:text-white">Transaction History</h2>
                <div class="mt-4 flex flex-col md:flex-row gap-4 justify-between items-center">
                    <div class="relative w-full md:max-w-xs">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                        <input class="form-input w-full pl-10 rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 placeholder:text-slate-400 focus:border-primary focus:ring-primary/50" placeholder="Search transactions..." type="text" id="searchInput" onkeyup="searchTransactions()"/>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <select class="form-select rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:border-primary focus:ring-primary/50 flex-1 md:flex-none" id="statusFilter" onchange="filterTransactions()">
                            <option value="all">Status: All</option>
                            <option value="issued">Issued</option>
                            <option value="returned">Returned</option>
                            <option value="partially_returned">Partially Returned</option>
                            <option value="overdue">Overdue</option>
                        </select>
                        <select class="form-select rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:border-primary focus:ring-primary/50 flex-1 md:flex-none" id="labFilter" onchange="filterTransactions()">
                            <option value="all">Lab: All</option>
                            {% for lab in labs %}
                            <option value="{{ lab.name }}">{{ lab.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Cards View -->
            <div class="block lg:hidden p-4 space-y-4">
                {% for transaction in transactions %}
                {% set pending = transaction.pending_quantity or (transaction.quantity_issued - transaction.quantity_returned) %}
                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4 border border-slate-200 dark:border-slate-600">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold text-slate-800 dark:text-slate-100 truncate">{{ transaction.component_name }}</h3>
                                {% if transaction.component_uid and transaction.component_uid != 'N/A' %}
                                <span class="bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300 text-xs px-2 py-1 rounded font-mono">{{ transaction.component_uid }}</span>
                                {% endif %}
                            </div>
                            <p class="text-sm text-slate-600 dark:text-slate-300">{{ transaction.lab }} â€¢ {{ transaction.issued_to }}</p>
                            <p class="text-sm text-slate-600 dark:text-slate-300">Campus: {{ transaction.campus or 'N/A' }}</p>
                        </div>
                        <div class="flex gap-1 ml-2">
                            <button onclick="editTransaction('{{ transaction._id }}')" class="p-1.5 rounded-md hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-500 dark:text-slate-400 hover:text-primary">
                                <span class="material-symbols-outlined text-base">edit</span>
                            </button>
                            <button onclick="deleteTransaction('{{ transaction._id }}')" class="p-1.5 rounded-md hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-500 dark:text-slate-400 hover:text-red-500">
                                <span class="material-symbols-outlined text-base">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 text-sm mb-3">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400">Issued</p>
                            <p class="font-medium text-slate-800 dark:text-slate-100">{{ transaction.quantity_issued }}</p>
                        </div>
                        <div>
                            <p class="text-slate-500 dark:text-slate-400">Returned</p>
                            <p class="font-medium text-slate-800 dark:text-slate-100">{{ transaction.quantity_returned }}</p>
                        </div>
                        <div>
                            <p class="text-slate-500 dark:text-slate-400">Pending</p>
                            <p class="font-medium {% if pending > 0 %}text-orange-500{% else %}text-slate-800 dark:text-slate-100{% endif %}">
                                {{ pending }}
                            </p>
                        </div>
                    </div>
                    
                    <div class="text-sm space-y-1">
                        <p class="text-slate-600 dark:text-slate-300 truncate" title="{{ transaction.purpose }}">
                            <span class="font-medium">Purpose:</span> {{ transaction.purpose or 'N/A' }}
                        </p>
                        <p class="text-slate-600 dark:text-slate-300">
                            <span class="font-medium">Issue Date:</span> 
                            {% if transaction.issue_date %}
                                {{ transaction.issue_date|timezone_filter('Asia/Kolkata')|datetime_format('%Y-%m-%d %H:%M') }}
                            {% else %}
                                -
                            {% endif %}
                        </p>
                        {% if transaction.return_date %}
                        <p class="text-slate-600 dark:text-slate-300">
                            <span class="font-medium">Return Date:</span> {{ transaction.return_date|timezone_filter('Asia/Kolkata')|datetime_format('%Y-%m-%d %H:%M') }}
                        </p>
                        {% endif %}
                    </div>
                    
                    <div class="mt-3">
                        {% if transaction.status == 'returned' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Returned</span>
                        {% elif transaction.status == 'partially_returned' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Partially Returned</span>
                        {% elif transaction.status == 'overdue' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Overdue</span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Issued</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Desktop Table View -->
            <div class="hidden lg:block overflow-x-auto">
                <table class="w-full text-sm text-left" id="transactionsTable">
                    <thead class="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-700 border-b border-t border-slate-200 dark:border-slate-700">
                        <tr>
                            <th class="px-6 py-3" scope="col">Component Name</th>
                            <th class="px-6 py-3" scope="col">UID</th>
                            <th class="px-6 py-3" scope="col">Lab</th>
                            <th class="px-6 py-3" scope="col">Issued To</th>
                            <th class="px-6 py-3" scope="col">Campus</th>
                            <th class="px-6 py-3 text-center" scope="col">Qty Issued</th>
                            <th class="px-6 py-3 text-center" scope="col">Qty Returned</th>
                            <th class="px-6 py-3 text-center" scope="col">Pending Qty</th>
                            <th class="px-6 py-3" scope="col">Purpose</th>
                            <th class="px-6 py-3 text-center" scope="col">Status</th>
                            <th class="px-6 py-3" scope="col">Issue Date</th>
                            <th class="px-6 py-3" scope="col">Return Date</th>
                            <th class="px-6 py-3 text-center" scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                        {% for transaction in transactions %}
                        {% set pending = transaction.pending_quantity or (transaction.quantity_issued - transaction.quantity_returned) %}
                        <tr class="bg-white dark:bg-transparent border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50/50 dark:hover:bg-slate-700/50">
                            <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">{{ transaction.component_name }}</td>
                            <td class="px-6 py-4 font-mono text-slate-600 dark:text-slate-300 text-sm">
                                {% if transaction.component_uid and transaction.component_uid != 'N/A' %}
                                {{ transaction.component_uid }}
                                {% else %}
                                <span class="text-slate-400">N/A</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-slate-600 dark:text-slate-300">{{ transaction.lab }}</td>
                            <td class="px-6 py-4 text-slate-600 dark:text-slate-300">{{ transaction.issued_to }}</td>
                            <td class="px-6 py-4 text-slate-600 dark:text-slate-300">{{ transaction.campus or '-' }}</td>
                            <td class="px-6 py-4 text-center text-slate-600 dark:text-slate-300">{{ transaction.quantity_issued }}</td>
                            <td class="px-6 py-4 text-center text-slate-600 dark:text-slate-300">{{ transaction.quantity_returned }}</td>
                            <td class="px-6 py-4 text-center {% if pending > 0 %}text-orange-500 font-bold{% else %}text-slate-600 dark:text-slate-300{% endif %}">
                                {{ pending }}
                            </td>
                            <td class="px-6 py-4 text-slate-600 dark:text-slate-300 max-w-xs truncate" title="{{ transaction.purpose }}">
                                {{ transaction.purpose or 'N/A' }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if transaction.status == 'returned' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Returned</span>
                                {% elif transaction.status == 'partially_returned' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Partially Returned</span>
                                {% elif transaction.status == 'overdue' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Overdue</span>
                                {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Issued</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-slate-600 dark:text-slate-300">
                                {% if transaction.issue_date %}
                                    {{ transaction.issue_date|timezone_filter('Asia/Kolkata')|datetime_format('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-slate-600 dark:text-slate-300">
                                {% if transaction.return_date %}
                                    {{ transaction.return_date|timezone_filter('Asia/Kolkata')|datetime_format('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button onclick="editTransaction('{{ transaction._id }}')" class="text-slate-500 hover:text-primary">
                                        <span class="material-symbols-outlined text-base">edit</span>
                                    </button>
                                    <button onclick="deleteTransaction('{{ transaction._id }}')" class="text-slate-500 hover:text-red-500">
                                        <span class="material-symbols-outlined text-base">delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="p-4 flex flex-col sm:flex-row justify-between items-center text-sm text-slate-600 dark:text-slate-400 gap-4">
                <p id="transactionCount">Showing {{ transactions|length }} transactions</p>
                {% if transactions|length > 10 %}
                <div class="flex items-center gap-1">
                    <button class="px-2 py-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 disabled:opacity-50" disabled>Previous</button>
                    <button class="px-3 py-1 rounded-md bg-primary/10 text-primary dark:bg-primary/20">1</button>
                    {% if transactions|length > 20 %}
                    <button class="px-3 py-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">2</button>
                    <button class="px-3 py-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">3</button>
                    <span class="px-2">...</span>
                    <button class="px-3 py-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">{{ (transactions|length / 10)|round(0, 'ceil')|int }}</button>
                    {% endif %}
                    <button class="px-2 py-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">Next</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div id="transactionModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 hidden">
    <div class="w-full max-w-md rounded-xl bg-white dark:bg-slate-900 shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between border-b border-slate-200 dark:border-slate-800 p-6 sticky top-0 bg-white dark:bg-slate-900">
            <h3 class="text-xl font-bold text-slate-900 dark:text-white">Edit Transaction</h3>
            <button onclick="closeTransactionModal()" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <form id="transactionEditForm" class="flex flex-col gap-6 p-6">
            <input type="hidden" id="editTransactionId">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300" for="editQuantityIssued">Quantity Issued</label>
                    <input class="form-input w-full rounded-lg border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300" 
                           id="editQuantityIssued" type="number" readonly disabled/>
                </div>
                <div>
                    <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300" for="editQuantityReturned">Quantity Returned</label>
                    <input class="form-input w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder:text-slate-400 focus:border-primary focus:ring-2 focus:ring-primary/20" 
                           id="editQuantityReturned" placeholder="0" type="number" min="0" required 
                           onchange="updatePendingQuantity()"/>
                </div>
            </div>
            <div>
                <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300" for="editPendingQuantity">Pending Quantity</label>
                <input class="form-input w-full rounded-lg border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300" 
                       id="editPendingQuantity" type="number" readonly disabled/>
            </div>
            <div>
                <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300" for="editStatus">Status</label>
                <select class="form-select w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:border-primary focus:ring-2 focus:ring-primary/20" id="editStatus" required>
                    <option value="issued">Issued</option>
                    <option value="partially_returned">Partially Returned</option>
                    <option value="returned">Returned</option>
                </select>
            </div>
            <div>
                <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300" for="editPurpose">Purpose</label>
                <textarea class="form-textarea w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder:text-slate-400 focus:border-primary focus:ring-2 focus:ring-primary/20" id="editPurpose" placeholder="Purpose..." rows="2"></textarea>
            </div>
            <div>
                <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300" for="editCampus">Campus</label>
                <input class="form-input w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder:text-slate-400 focus:border-primary focus:ring-2 focus:ring-primary/20" id="editCampus" placeholder="Campus name" type="text"/>
            </div>
        </form>
        <div class="flex justify-end gap-4 border-t border-slate-200 dark:border-slate-800 p-6 sticky bottom-0 bg-white dark:bg-slate-900">
            <button onclick="closeTransactionModal()" class="h-11 rounded-lg px-5 text-sm font-bold bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-700">Cancel</button>
            <button onclick="updateTransaction()" class="h-11 rounded-lg bg-primary px-5 text-sm font-bold text-white hover:bg-primary/90">Update Transaction</button>
        </div>
    </div>
</div>

<script>
let transactionType = 'issue';
let currentEditingTransactionId = null;
let originalTransactionData = null;

function toggleTransactionType(type) {
    transactionType = type;
    const quantityLabel = document.getElementById('quantityLabel');
    const submitButton = document.getElementById('submitButton');
    
    if (type === 'return') {
        quantityLabel.textContent = 'Quantity to Return';
        submitButton.textContent = 'Return Component';
    } else {
        quantityLabel.textContent = 'Quantity to Issue';
        submitButton.textContent = 'Issue Component';
    }
}

async function loadComponentsByLab() {
    const labSelect = document.getElementById('lab');
    const componentSelect = document.getElementById('component');
    const componentUidInput = document.getElementById('componentUid');
    const selectedLab = labSelect.value;
    
    if (!selectedLab) {
        componentSelect.innerHTML = '<option value="">Select Component</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/components/by-lab/${encodeURIComponent(selectedLab)}`);
        if (!response.ok) {
            throw new Error('Failed to load components');
        }
        const components = await response.json();
        
        componentSelect.innerHTML = '<option value="">Select Component</option>';
        components.forEach(component => {
            const option = document.createElement('option');
            option.value = component.name;
            const uidDisplay = component.uid ? ` [${component.uid}]` : '';
            option.textContent = `${component.name}${uidDisplay} (Available: ${component.current_quantity})`;
            componentSelect.appendChild(option);
        });
        
        // Clear UID input when lab changes
        componentUidInput.value = '';
    } catch (error) {
        console.error('Error loading components:', error);
        alert('Error loading components for selected lab');
    }
}

async function loadComponentByUid() {
    const componentUidInput = document.getElementById('componentUid');
    const componentSelect = document.getElementById('component');
    const labSelect = document.getElementById('lab');
    const uid = componentUidInput.value.trim().toUpperCase();
    
    if (!uid) {
        return;
    }
    
    try {
        // Use the new API endpoint to get all components for UID lookup
        const response = await fetch('/api/components');
        if (!response.ok) {
            throw new Error('Failed to search components by UID');
        }
        const components = await response.json();
        
        const component = components.find(c => c.uid === uid);
        if (component) {
            // Set the lab and component selection
            labSelect.value = component.lab;
            
            // Reload components for this lab and select the matching one
            await loadComponentsByLab();
            
            // Wait a moment for the component dropdown to populate, then select the matching component
            setTimeout(() => {
                componentSelect.value = component.name;
                componentUidInput.value = component.uid; // Keep the UID visible
            }, 100);
        } else {
            alert('Component with UID ' + uid + ' not found');
            componentUidInput.value = '';
        }
    } catch (error) {
        console.error('Error loading component by UID:', error);
        alert('Error finding component by UID. Please try again.');
    }
}

async function createTransaction() {
    const componentSelect = document.getElementById('component');
    const componentUidInput = document.getElementById('componentUid');
    const labSelect = document.getElementById('lab');
    const recipientInput = document.getElementById('recipient');
    const campusInput = document.getElementById('campus');
    const quantityInput = document.getElementById('quantity');
    
    // Validate required fields
    if (!labSelect.value) {
        alert('Please select a lab');
        return;
    }
    
    if (!componentSelect.value && !componentUidInput.value) {
        alert('Please select a component or enter a UID');
        return;
    }
    
    if (!recipientInput.value) {
        alert('Please enter recipient name');
        return;
    }
    
    if (!campusInput.value) {
        alert('Please enter campus name');
        return;
    }
    
    if (!quantityInput.value || parseInt(quantityInput.value) <= 0) {
        alert('Please enter a valid quantity');
        return;
    }
    
    // If UID is provided but no component is selected, try to find the component
    if (componentUidInput.value && !componentSelect.value) {
        await loadComponentByUid();
        // Check again if component is now selected
        if (!componentSelect.value) {
            alert('Could not find component with the provided UID');
            return;
        }
    }
    
    const formData = {
        component_name: componentSelect.value,
        lab: labSelect.value,
        issued_to: recipientInput.value,
        campus: campusInput.value,
        purpose: document.getElementById('purpose').value,
        type: transactionType
    };

    if (transactionType === 'issue') {
        formData.quantity_issued = parseInt(quantityInput.value);
    } else {
        formData.quantity_returned = parseInt(quantityInput.value);
    }

    try {
        const response = await fetch('/api/transactions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            document.getElementById('transactionForm').reset();
            alert('Transaction completed successfully!');
            location.reload();
        } else {
            const error = await response.json();
            alert(error.error || 'Error creating transaction');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error creating transaction. Please try again.');
    }
}

function editTransaction(transactionId) {
    currentEditingTransactionId = transactionId;
    fetchTransactionData(transactionId);
}

async function fetchTransactionData(transactionId) {
    try {
        const response = await fetch(`/api/transactions/${transactionId}`);
        if (response.ok) {
            const transaction = await response.json();
            originalTransactionData = transaction; // Store original data for comparison
            
            // Parse date strings back to Date objects if needed
            if (transaction.issue_date && typeof transaction.issue_date === 'string') {
                transaction.issue_date = new Date(transaction.issue_date);
            }
            if (transaction.return_date && typeof transaction.return_date === 'string') {
                transaction.return_date = new Date(transaction.return_date);
            }
            
            document.getElementById('editStatus').value = transaction.status;
            document.getElementById('editQuantityIssued').value = transaction.quantity_issued;
            document.getElementById('editQuantityReturned').value = transaction.quantity_returned || 0;
            
            // Calculate and display pending quantity
            const pendingQuantity = transaction.pending_quantity || (transaction.quantity_issued - transaction.quantity_returned);
            document.getElementById('editPendingQuantity').value = pendingQuantity;
            
            document.getElementById('editPurpose').value = transaction.purpose || '';
            document.getElementById('editCampus').value = transaction.campus || '';
            document.getElementById('transactionModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        } else {
            const error = await response.json();
            alert('Error fetching transaction data: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error fetching transaction data. Please try again.');
    }
}

function closeTransactionModal() {
    document.getElementById('transactionModal').classList.add('hidden');
    currentEditingTransactionId = null;
    originalTransactionData = null;
    document.body.style.overflow = 'auto';
}

// Add this function to update pending quantity in real-time
function updatePendingQuantity() {
    const quantityIssued = parseInt(document.getElementById('editQuantityIssued').value) || 0;
    const quantityReturned = parseInt(document.getElementById('editQuantityReturned').value) || 0;
    const pendingQuantity = quantityIssued - quantityReturned;
    
    document.getElementById('editPendingQuantity').value = pendingQuantity;
    
    // Update status based on pending quantity
    const statusSelect = document.getElementById('editStatus');
    if (pendingQuantity === 0) {
        statusSelect.value = 'returned';
    } else if (pendingQuantity === quantityIssued) {
        statusSelect.value = 'issued';
    } else {
        statusSelect.value = 'partially_returned';
    }
    
    // Validate that returned quantity doesn't exceed issued quantity
    if (quantityReturned > quantityIssued) {
        alert('Returned quantity cannot exceed issued quantity');
        document.getElementById('editQuantityReturned').value = quantityIssued;
        document.getElementById('editPendingQuantity').value = 0;
        statusSelect.value = 'returned';
    } else if (pendingQuantity < 0) {
        alert('Pending quantity cannot be negative');
        document.getElementById('editQuantityReturned').value = quantityIssued;
        document.getElementById('editPendingQuantity').value = 0;
        statusSelect.value = 'returned';
    }
}

async function updateTransaction() {
    const status = document.getElementById('editStatus').value;
    const quantityReturned = parseInt(document.getElementById('editQuantityReturned').value) || 0;
    const purpose = document.getElementById('editPurpose').value;
    const campus = document.getElementById('editCampus').value;

    // Validate quantity returned
    if (quantityReturned < 0) {
        alert('Quantity returned cannot be negative');
        return;
    }

    const originalQuantityIssued = originalTransactionData ? originalTransactionData.quantity_issued : 0;
    
    // Validate that returned quantity doesn't exceed issued quantity
    if (quantityReturned > originalQuantityIssued) {
        alert(`Quantity returned (${quantityReturned}) cannot exceed quantity issued (${originalQuantityIssued})`);
        return;
    }

    const formData = {
        status: status,
        quantity_returned: quantityReturned,
        purpose: purpose,
        campus: campus
    };

    try {
        const response = await fetch(`/api/transactions/${currentEditingTransactionId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            closeTransactionModal();
            alert('Transaction updated successfully! Component quantities have been adjusted accordingly.');
            location.reload();
        } else {
            const error = await response.json();
            alert(error.error || 'Error updating transaction');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating transaction. Please try again.');
    }
}

async function deleteTransaction(transactionId) {
    if (confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
        try {
            const response = await fetch(`/api/transactions/${transactionId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert(error.error || 'Error deleting transaction');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting transaction. Please try again.');
        }
    }
}

function searchTransactions() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.getElementById('transactionsBody').getElementsByTagName('tr');
    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
            if (cells[j].textContent.toLowerCase().includes(input)) {
                found = true;
                break;
            }
        }
        
        if (found) {
            rows[i].style.display = '';
            visibleCount++;
        } else {
            rows[i].style.display = 'none';
        }
    }
    
    document.getElementById('transactionCount').textContent = `Showing ${visibleCount} transactions`;
}

function filterTransactions() {
    const statusFilter = document.getElementById('statusFilter').value;
    const labFilter = document.getElementById('labFilter').value;
    const rows = document.getElementById('transactionsBody').getElementsByTagName('tr');
    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        const statusCell = cells[8]; // Status column index (9th cell, index 8)
        const labCell = cells[2]; // Lab column index (3rd cell, index 2)
        
        const statusMatch = statusFilter === 'all' || statusCell.textContent.toLowerCase().includes(statusFilter);
        const labMatch = labFilter === 'all' || labCell.textContent === labFilter;
        
        if (statusMatch && labMatch) {
            rows[i].style.display = '';
            visibleCount++;
        } else {
            rows[i].style.display = 'none';
        }
    }
    
    document.getElementById('transactionCount').textContent = `Showing ${visibleCount} transactions`;
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    toggleTransactionType('issue');
});

// Close modal when clicking outside
document.getElementById('transactionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTransactionModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeTransactionModal();
    }
});
</script>
{% endblock %}